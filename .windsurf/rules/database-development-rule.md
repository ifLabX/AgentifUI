---
trigger: always_on
description: 数据库开发规范
globs:
---
# 数据库开发规范

本文档规定了项目中数据库相关开发的规范和流程，确保数据库结构的一致性和可维护性。

## 参考文档

- **主要参考文档**: `/DATABASE-DESIGN.md` - 包含完整的数据库设计，表结构，关系和设计原则
- **API密钥管理**: `/README-API-KEY-MANAGEMENT.md` - 专门介绍API密钥管理系统的实现

## 数据库结构修改流程

1. **创建迁移文件**:
   - 所有数据库结构变更必须通过迁移文件实现
   - 迁移文件命名格式: `YYYYMMDDHHMMSS_描述.sql`
   - 放置在 `/supabase/migrations/` 目录下

2. **迁移文件内容要求**:
   - 每个迁移文件必须是幂等的（可重复执行而不产生错误）
   - 使用 `IF NOT EXISTS` 或 `DO $$` 块进行条件检查
   - 为每个表启用行级安全性 (RLS)
   - 为每个表创建适当的安全策略

3. **更新文档**:
   - 结构变更后必须更新 `DATABASE-DESIGN.md` 文档
   - 添加新表时，包含完整的字段描述和关系说明
   - 修改现有表时，记录变更内容和原因

## 数据库使用规范

1. **类型安全**:
   - 使用 `types/database.ts` 中定义的类型
   - 不要使用 `any` 类型绕过类型检查

2. **查询构建**:
   - 使用参数化查询，避免SQL注入
   - 复杂查询应该在 `lib/db/` 目录下封装为函数
   - 查询函数应该有清晰的注释说明用途和参数

3. **事务处理**:
   - 涉及多表操作时必须使用事务
   - 事务应该有适当的错误处理和回滚机制

## 安全规范

1. **敏感数据处理**:
   - API密钥等敏感信息必须加密存储
   - 使用 `lib/utils/encryption.ts` 中的加密/解密函数
   - 不要在日志中记录敏感信息

2. **行级安全性**:
   - 所有表必须启用RLS
   - 按照最小权限原则设计安全策略
   - 测试不同角色用户的访问权限

## 新表添加流程

1. **设计阶段**:
   - 在 `DATABASE-DESIGN.md` 中添加新表设计
   - 明确字段类型、约束和关系
   - 设计适当的索引提高查询性能

2. **实现阶段**:
   - 创建迁移文件实现表结构
   - 实现RLS策略和触发器
   - 添加必要的索引和约束

3. **验证阶段**:
   - 测试表的CRUD操作
   - 验证RLS策略是否正确
   - 确认与现有表的关系是否正确

## 常见问题处理

1. **迁移失败**:
   - 检查SQL语法
   - 确认表和字段是否已存在
   - 使用条件检查避免重复创建

2. **性能问题**:
   - 检查是否缺少必要的索引
   - 优化查询语句
   - 考虑使用视图或物化视图

3. **类型不匹配**:
   - 更新 `types/database.ts` 中的类型定义
   - 确保前端和后端使用一致的类型

## 后续开发计划

1. **短期计划**:
   - 完善API密钥轮换机制
   - 添加更多API提供商支持
   - 实现用户自定义API密钥功能

2. **中期计划**:
   - 优化数据库索引结构
   - 添加数据库监控和性能分析
   - 实现数据库分区策略

3. **长期计划**:
   - 考虑引入NoSQL存储特定数据
   - 实现数据库读写分离
   - 设计数据归档和清理策略
